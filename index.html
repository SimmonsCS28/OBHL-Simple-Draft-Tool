<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey League Draft Application</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Menu */
        .top-menu {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }

        .menu-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .menu-button:hover {
            background-color: #2980b9;
        }

        .menu-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .menu-button.active {
            background-color: #27ae60;
        }

        .menu-button.danger {
            background-color: #e74c3c;
        }

        .menu-button.danger:hover {
            background-color: #c0392b;
        }

        .menu-button.warning {
            background-color: #f39c12;
        }

        .menu-button.warning:hover {
            background-color: #e67e22;
        }

        .menu-input, .menu-select {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 14px;
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        
        .menu-input.invalid, .menu-select.invalid {
            border: 2px solid #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
        }
        
        .menu-input.valid, .menu-select.valid {
            border: 2px solid #27ae60;
        }
        
        .validation-message {
            position: absolute;
            top: 100%;
            left: 20px;
            right: 20px;
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            z-index: 100;
        }
        
        .validation-message.show {
            display: block;
        }
        
        .start-requirements {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #e74c3c;
        }
        
        .start-requirements.ready {
            color: #27ae60;
        }

        /* Save Status Indicator */
        .save-status {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            background-color: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-status.show {
            opacity: 1;
        }

        .save-status.error {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border-color: #e74c3c;
        }

        /* Resume Draft Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background-color: #2a2a2a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #3498db;
        }

        .modal-text {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-info {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: left;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Player Pool */
        .player-pool {
            width: 300px;
            background-color: #2a2a2a;
            border-right: 2px solid #444;
            display: flex;
            flex-direction: column;
        }

        .pool-header {
            background-color: #1a1a1a;
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .filter-section {
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .filter-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .filter-btn {
            padding: 5px 10px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background-color: #4a4a4a;
        }

        .filter-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .filter-select {
            flex: 1;
            padding: 6px;
            background-color: #3a3a3a;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .sort-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sort-button:hover {
            background-color: #c0392b;
        }

        .players-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Player Card */
        .player-card {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
            font-weight: bold;
        }

        .player-card:hover {
            background-color: #4a4a4a;
            transform: translateY(-1px);
        }

        .player-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .player-card.compact {
            padding: 6px 10px;
        }

        .player-card.compact .player-details {
            display: flex;
            gap: 10px;
            font-size: 11px;
        }

        .player-card.compact .player-detail:not(.show-compact) {
            display: none;
        }
        
        .player-card.compact .skill-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .warning-icon {
            color: #e74c3c;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .player-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .player-details {
            font-size: 12px;
            color: #aaa;
        }

        .player-detail {
            margin-bottom: 2px;
        }

        .player-detail.missing-rating {
            background-color: #e74c3c;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }

        .player-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        .tag-ref {
            background-color: #f39c12;
            color: white;
        }

        .tag-gm {
            background-color: #8e44ad;
            color: white;
        }

        .player-edit-select {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 3px;
            padding: 2px 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 5px;
        }

        .player-edit-select:hover {
            background-color: #3a3a3a;
        }

        /* Missing rating styles - multiple selectors for specificity */
        select.missing-rating,
        .missing-rating.skill-select,
        .missing-rating.player-edit-select,
        .player-card .missing-rating,
        .player-card.compact .missing-rating,
        .player-details .missing-rating {
            background-color: #e74c3c !important;
            color: white !important;
            border: 1px solid #c0392b !important;
            font-weight: bold !important;
        }

        select.missing-rating:hover,
        .missing-rating.skill-select:hover,
        .missing-rating.player-edit-select:hover {
            background-color: #c0392b !important;
        }
        
        /* Specific targeting for compact mode select elements */
        .compact .player-details select.missing-rating {
            background-color: #e74c3c !important;
            color: white !important;
            border-color: #c0392b !important;
        }
        
        /* Target the option text as well */
        select.missing-rating option {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        
        select.missing-rating option[value="0"] {
            background-color: #e74c3c;
            color: white;
        }

        /* Zero Rating Warning Modal */
        .warning-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2a2a2a;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 20px;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-width: 400px;
        }

        .warning-modal.show {
            display: block;
        }

        .warning-modal h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .warning-modal p {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .warning-modal button {
            margin-top: 15px;
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        .warning-modal button:hover {
            background-color: #2980b9;
        }

        /* Draft Board */
        .draft-board {
            flex: 1;
            overflow-x: auto;
            padding: 20px;
            background-color: #222;
        }

        .teams-container {
            display: flex;
            gap: 15px;
            min-width: max-content;
        }

        .team-column {
            width: 220px;
            background-color: #2a2a2a;
            border: 2px solid #555;
            border-radius: 8px;
            min-height: 600px;
        }

        .team-header {
            padding: 10px;
            border-bottom: 2px solid #bdc3c7;
            font-weight: bold;
        }

        .team-color-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .color-select {
            flex: 1;
            padding: 6px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #3a3a3a;
            color: #e0e0e0;
        }

        .team-sort-select {
            padding: 4px;
            font-size: 11px;
            border: 1px solid #555;
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 5px;
            width: 100%;
        }

        .team-stats {
            font-size: 11px;
            font-weight: bold;
        }
        
        /* Ensure stats text inherits the header color for visibility */
        .team-header .team-stats {
            color: inherit;
            opacity: 0.9;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .stat-row span:last-child {
            font-weight: bold;
        }

        .team-players {
            padding: 10px;
            min-height: 500px;
        }
        
        .team-players .player-card {
            font-weight: bold;
        }

        .team-players.drag-over {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .drop-zone {
            min-height: 500px;
            border: 2px dashed #555;
            color: #999;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            margin-top: 10px;
        }

        .drop-zone.drag-over {
            border-color: #3498db;
            background-color: #1a3d5c;
        }

        /* Updated Color Classes with better contrast */
        .team-red { background-color: #fb0102; color: #ffffff; }
        .team-blue { background-color: #0100fe; color: #ffffff; }
        .team-lt-blue { background-color: #5e9ed6; color: #ffffff; }
        .team-tan { background-color: #b8956f; color: #ffffff; }
        .team-black { background-color: #000000; color: #ffffff; }
        .team-orange { background-color: #fd9a01; color: #000000; }
        .team-green { background-color: #39751f; color: #ffffff; }
        .team-teal { background-color: #007a7a; color: #ffffff; }
        .team-maroon { background-color: #a64d79; color: #ffffff; }
        .team-gray { background-color: #666666; color: #ffffff; }
        .team-purple { background-color: #9a00ff; color: #ffffff; }
        .team-white { background-color: #f0f0f0; color: #000000; border: 2px solid #000; }

        .hidden {
            display: none;
        }

        .file-input {
            display: none;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .toggle-label {
            font-size: 12px;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Top Menu -->
    <div class="top-menu">
        <button class="menu-button" id="startDraftBtn" disabled>Start Draft</button>
        <button class="menu-button" id="assignGMsBtn" disabled>Assign GMs</button>
        <button class="menu-button" id="saveDraftBtn" disabled>Save Draft</button>
        <button class="menu-button" id="resetDraftBtn" disabled>Reset Draft</button>
        <button class="menu-button danger" id="clearStorageBtn" style="display: none;">Clear Saved Data</button>
        
        <select class="menu-select" id="numTeamsSelect">
            <option value="">Select Number of Teams</option>
            <option value="6">6 Teams</option>
            <option value="7">7 Teams</option>
            <option value="8">8 Teams</option>
            <option value="9">9 Teams</option>
            <option value="10">10 Teams</option>
            <option value="11">11 Teams</option>
            <option value="12">12 Teams</option>
        </select>
        
        <button class="menu-button" id="downloadTemplateBtn">Download Template</button>
        <button class="menu-button" id="uploadFileBtn">Upload File</button>
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
        
        <input type="text" class="menu-input" id="seasonNameInput" placeholder="Name of Season">
        
        <div class="view-toggle">
            <span class="toggle-label">Compact:</span>
            <button class="menu-button" id="toggleCompactBtn">OFF</button>
        </div>
        
        <div class="start-requirements" id="startRequirements">
            <span id="requirementsText">Missing: Teams, Players, Season Name</span>
        </div>
        
        <div class="save-status" id="saveStatus">✓ Draft Saved</div>
    </div>

    <!-- Resume Draft Modal -->
    <div class="modal-overlay" id="resumeModal">
        <div class="modal-content">
            <h2 class="modal-title">Resume Previous Draft?</h2>
            <p class="modal-text">A saved draft was found. Would you like to continue where you left off?</p>
            <div class="modal-info" id="savedDraftInfo">
                <!-- Draft info will be populated here -->
            </div>
            <div class="modal-buttons">
                <button class="menu-button" id="resumeDraftBtn">Resume Draft</button>
                <button class="menu-button warning" id="startFreshBtn">Start Fresh</button>
            </div>
        </div>
    </div>
    
    <!-- Reset Confirmation Modal -->
    <div class="modal-overlay" id="resetConfirmModal">
        <div class="modal-content">
            <h2 class="modal-title" style="color: #e74c3c;">Reset Draft?</h2>
            <p class="modal-text">Are you sure you want to reset the draft?</p>
            <p class="modal-text" style="font-weight: bold;">This action cannot be undone!</p>
            <p class="modal-text" style="margin-top: 15px;">All team assignments will be cleared and all players will return to the pool.</p>
            <div class="modal-buttons">
                <button class="menu-button" id="cancelResetBtn">Cancel</button>
                <button class="menu-button danger" id="confirmResetBtn">Reset Draft</button>
            </div>
        </div>
    </div>

    <!-- Zero Rating Warning Modal -->
    <div class="warning-modal" id="zeroRatingModal">
        <h3>Missing Skill Rating</h3>
        <p id="zeroRatingMessage">This player has no skill rating assigned. Please set a skill rating between 1-10 before assigning to a team.</p>
        <button id="zeroRatingOkBtn">OK</button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Player Pool -->
        <div class="player-pool">
            <div class="pool-header">Player Pool</div>
            
            <div class="filter-section">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="forward">Forwards</button>
                    <button class="filter-btn" data-filter="defense">Defense</button>
                    <button class="filter-btn" data-filter="ref">Refs</button>
                    <button class="filter-btn" data-filter="gm">GMs</button>
                    <button class="filter-btn" data-filter="buddy">Has Buddy</button>
                </div>
                
                <div class="filter-row">
                    <select class="filter-select" id="sortBySelect">
                        <option value="name">Player Name</option>
                        <option value="position">Position</option>
                        <option value="skill">Skill Rating</option>
                        <option value="veteran">Veteran Status</option>
                    </select>
                    <button class="sort-button" id="sortBtn" data-order="asc">↑</button>
                </div>
            </div>
            
            <div class="players-container" id="playersContainer">
                <!-- Player cards will be populated here -->
            </div>
        </div>

        <!-- Draft Board -->
        <div class="draft-board">
            <div class="teams-container" id="teamsContainer">
                <!-- Team columns will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let players = [];
        let teams = [];
        let currentSort = { by: 'name', order: 'asc' };
        let currentFilter = 'all';
        let draftStarted = false;
        let compactView = false;
        let seasonName = '';

        // Storage configuration
        const STORAGE_KEY = 'hockeyDraftState';
        const STORAGE_VERSION = '1.0';
        let autoSaveEnabled = true;
        let saveTimeout = null;

        // Team colors
        const teamColors = [
            { value: 'red', label: 'Red', class: 'team-red' },
            { value: 'blue', label: 'Blue', class: 'team-blue' },
            { value: 'lt-blue', label: 'Lt. Blue', class: 'team-lt-blue' },
            { value: 'tan', label: 'Tan', class: 'team-tan' },
            { value: 'black', label: 'Black', class: 'team-black' },
            { value: 'orange', label: 'Orange', class: 'team-orange' },
            { value: 'green', label: 'Green', class: 'team-green' },
            { value: 'teal', label: 'Teal', class: 'team-teal' },
            { value: 'maroon', label: 'Maroon', class: 'team-maroon' },
            { value: 'gray', label: 'Gray', class: 'team-gray' },
            { value: 'purple', label: 'Purple', class: 'team-purple' },
            { value: 'white', label: 'White', class: 'team-white' }
        ];

        // Validation function to check if ready to start draft
        function validateStartRequirements() {
            const numTeams = document.getElementById('numTeamsSelect').value;
            const seasonName = document.getElementById('seasonNameInput').value.trim();
            const hasPlayers = players.length > 0;
            
            const numTeamsSelect = document.getElementById('numTeamsSelect');
            const seasonNameInput = document.getElementById('seasonNameInput');
            const uploadBtn = document.getElementById('uploadFileBtn');
            const startBtn = document.getElementById('startDraftBtn');
            const requirementsDiv = document.getElementById('startRequirements');
            const requirementsText = document.getElementById('requirementsText');
            
            let missing = [];
            let isValid = true;
            
            // Check teams
            if (!numTeams) {
                missing.push('Teams');
                numTeamsSelect.classList.add('invalid');
                numTeamsSelect.classList.remove('valid');
                isValid = false;
            } else {
                numTeamsSelect.classList.add('valid');
                numTeamsSelect.classList.remove('invalid');
            }
            
            // Check season name
            if (!seasonName) {
                missing.push('Season Name');
                seasonNameInput.classList.add('invalid');
                seasonNameInput.classList.remove('valid');
                isValid = false;
            } else {
                seasonNameInput.classList.add('valid');
                seasonNameInput.classList.remove('invalid');
            }
            
            // Check players
            if (!hasPlayers) {
                missing.push('Players (Upload File)');
                uploadBtn.classList.add('invalid');
                isValid = false;
            } else {
                uploadBtn.classList.remove('invalid');
                uploadBtn.classList.add('valid');
            }
            
            // Update UI
            if (isValid && !draftStarted) {
                startBtn.disabled = false;
                requirementsDiv.classList.add('ready');
                requirementsText.textContent = '✓ Ready to start draft!';
                requirementsText.style.color = '#27ae60';
            } else if (!draftStarted) {
                startBtn.disabled = true;
                requirementsDiv.classList.remove('ready');
                requirementsText.textContent = 'Missing: ' + missing.join(', ');
                requirementsText.style.color = '#e74c3c';
            } else {
                // Draft already started
                requirementsDiv.style.display = 'none';
            }
            
            return isValid;
        }
        
        // Add validation listeners
        document.getElementById('numTeamsSelect').addEventListener('change', validateStartRequirements);
        document.getElementById('seasonNameInput').addEventListener('input', validateStartRequirements);
        
        // Call validation on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkForSavedDraft();
            validateStartRequirements();
            
            // Add modal close handlers
            const zeroRatingOkBtn = document.getElementById('zeroRatingOkBtn');
            if (zeroRatingOkBtn) {
                zeroRatingOkBtn.addEventListener('click', () => {
                    document.getElementById('zeroRatingModal').classList.remove('show');
                });
            }
            
            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                // Zero rating modal
                const zeroModal = document.getElementById('zeroRatingModal');
                if (zeroModal && zeroModal.classList.contains('show') && !zeroModal.contains(e.target)) {
                    zeroModal.classList.remove('show');
                }
                
                // Reset confirmation modal - clicking outside cancels
                const resetModal = document.getElementById('resetConfirmModal');
                if (resetModal && resetModal.classList.contains('show') && e.target === resetModal) {
                    resetModal.classList.remove('show');
                }
            });
        });

        // Auto-save functions
        function saveDraftToStorage() {
            if (!autoSaveEnabled || !draftStarted) return;
            
            try {
                const draftState = {
                    version: STORAGE_VERSION,
                    timestamp: new Date().toISOString(),
                    seasonName: document.getElementById('seasonNameInput').value,
                    players: players,
                    teams: teams.map(team => ({
                        ...team,
                        players: team.players.map(p => p.id) // Store only player IDs
                    })),
                    currentSort: currentSort,
                    currentFilter: currentFilter,
                    compactView: compactView,
                    draftStarted: draftStarted
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(draftState));
                showSaveStatus('success');
                document.getElementById('clearStorageBtn').style.display = 'inline-block';
                
                console.log('Draft auto-saved successfully');
            } catch (error) {
                console.error('Failed to save draft:', error);
                showSaveStatus('error');
            }
        }

        function loadDraftFromStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (!savedData) return false;
                
                const draftState = JSON.parse(savedData);
                
                // Check version compatibility
                if (draftState.version !== STORAGE_VERSION) {
                    console.warn('Saved draft version mismatch. Clearing old data.');
                    clearSavedDraft();
                    return false;
                }
                
                // Restore state
                players = draftState.players;
                seasonName = draftState.seasonName || '';
                document.getElementById('seasonNameInput').value = seasonName;
                
                // Restore teams with proper player references
                teams = draftState.teams.map(team => ({
                    ...team,
                    players: team.players.map(playerId => 
                        players.find(p => p.id === playerId)
                    ).filter(p => p) // Remove any missing players
                }));
                
                // Restore UI state
                currentSort = draftState.currentSort || { by: 'name', order: 'asc' };
                currentFilter = draftState.currentFilter || 'all';
                compactView = draftState.compactView || false;
                draftStarted = draftState.draftStarted || false;
                
                // Update UI elements
                document.getElementById('sortBySelect').value = currentSort.by;
                document.getElementById('sortBtn').textContent = currentSort.order === 'asc' ? '↑' : '↓';
                document.getElementById('sortBtn').dataset.order = currentSort.order;
                
                // Set number of teams
                if (teams.length > 0) {
                    document.getElementById('numTeamsSelect').value = teams.length.toString();
                }
                
                // Update compact view
                if (compactView) {
                    document.getElementById('toggleCompactBtn').textContent = 'ON';
                    document.getElementById('toggleCompactBtn').classList.add('active');
                }
                
                // Set active filter
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === currentFilter) {
                        btn.classList.add('active');
                    }
                });
                
                // Generate UI
                if (draftStarted) {
                    generateTeamColumns();
                    teams.forEach((team, index) => {
                        renderTeamPlayers(index + 1);
                        updateTeamStats(index + 1);
                    });
                    updateColorDropdowns();
                    updateButtonStates();
                }
                
                renderPlayers();
                document.getElementById('clearStorageBtn').style.display = 'inline-block';
                
                // Validate requirements after loading
                validateStartRequirements();
                
                console.log('Draft loaded successfully from', draftState.timestamp);
                return true;
            } catch (error) {
                console.error('Failed to load saved draft:', error);
                return false;
            }
        }

        function clearSavedDraft() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                document.getElementById('clearStorageBtn').style.display = 'none';
                console.log('Saved draft cleared');
            } catch (error) {
                console.error('Failed to clear saved draft:', error);
            }
        }

        function checkForSavedDraft() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (!savedData) return;
                
                const draftState = JSON.parse(savedData);
                const savedDate = new Date(draftState.timestamp);
                const now = new Date();
                const hoursSince = (now - savedDate) / (1000 * 60 * 60);
                
                // Build info text
                let infoText = `<strong>Season:</strong> ${draftState.seasonName || 'Unnamed'}<br>`;
                infoText += `<strong>Teams:</strong> ${draftState.teams.length}<br>`;
                infoText += `<strong>Players:</strong> ${draftState.players.length}<br>`;
                infoText += `<strong>Last Saved:</strong> ${savedDate.toLocaleString()}<br>`;
                
                if (hoursSince < 1) {
                    infoText += `<em>(${Math.round(hoursSince * 60)} minutes ago)</em>`;
                } else if (hoursSince < 24) {
                    infoText += `<em>(${Math.round(hoursSince)} hours ago)</em>`;
                } else {
                    infoText += `<em>(${Math.round(hoursSince / 24)} days ago)</em>`;
                }
                
                document.getElementById('savedDraftInfo').innerHTML = infoText;
                document.getElementById('resumeModal').classList.add('show');
                
            } catch (error) {
                console.error('Error checking for saved draft:', error);
                clearSavedDraft();
            }
        }

        function showSaveStatus(type) {
            const statusEl = document.getElementById('saveStatus');
            
            if (type === 'success') {
                statusEl.textContent = '✓ Draft Saved';
                statusEl.classList.remove('error');
            } else {
                statusEl.textContent = '✗ Save Failed';
                statusEl.classList.add('error');
            }
            
            statusEl.classList.add('show');
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                statusEl.classList.remove('show');
            }, 2000);
        }

        function triggerAutoSave() {
            if (!autoSaveEnabled || !draftStarted) return;
            saveDraftToStorage();
        }

        // Modal event listeners
        document.getElementById('resumeDraftBtn').addEventListener('click', () => {
            document.getElementById('resumeModal').classList.remove('show');
            if (loadDraftFromStorage()) {
                showSaveStatus('success');
            }
        });

        document.getElementById('startFreshBtn').addEventListener('click', () => {
            document.getElementById('resumeModal').classList.remove('show');
            clearSavedDraft();
        });

        document.getElementById('clearStorageBtn').addEventListener('click', () => {
            if (confirm('This will clear all saved draft data. Are you sure?')) {
                clearSavedDraft();
                alert('Saved draft data has been cleared.');
            }
        });

        // Event listeners
        document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
        document.getElementById('uploadFileBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('startDraftBtn').addEventListener('click', startDraft);
        document.getElementById('assignGMsBtn').addEventListener('click', assignGMsToTeams);
        document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
        document.getElementById('resetDraftBtn').addEventListener('click', () => {
            console.log('Reset button clicked - showing confirmation modal');
            // Show confirmation modal instead of directly resetting
            document.getElementById('resetConfirmModal').classList.add('show');
        });
        
        // Reset confirmation modal handlers
        document.getElementById('cancelResetBtn').addEventListener('click', () => {
            document.getElementById('resetConfirmModal').classList.remove('show');
        });
        
        document.getElementById('confirmResetBtn').addEventListener('click', () => {
            document.getElementById('resetConfirmModal').classList.remove('show');
            
            // Visual feedback
            const resetBtn = document.getElementById('resetDraftBtn');
            const originalText = resetBtn.textContent;
            resetBtn.textContent = 'Resetting...';
            resetBtn.disabled = true;
            
            setTimeout(() => {
                resetDraft();
                resetBtn.textContent = originalText;
                resetBtn.disabled = false;
            }, 100);
        });
        document.getElementById('sortBtn').addEventListener('click', toggleSort);
        document.getElementById('sortBySelect').addEventListener('change', updateSort);
        
        // Season name input - auto-save on change
        document.getElementById('seasonNameInput').addEventListener('input', () => {
            triggerAutoSave();
        });
        
        // Compact view toggle
        document.getElementById('toggleCompactBtn').addEventListener('click', () => {
            console.log('Compact view toggle clicked. Current state:', compactView);
            
            compactView = !compactView;
            const btn = document.getElementById('toggleCompactBtn');
            btn.textContent = compactView ? 'ON' : 'OFF';
            
            if (compactView) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            
            console.log('New compact view state:', compactView);
            
            // Re-render all player cards
            renderPlayers();
            teams.forEach((team, index) => {
                renderTeamPlayers(index + 1);
            });
            
            triggerAutoSave();
        });
        
        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderPlayers();
                triggerAutoSave();
            });
        });

        // Download template
        function downloadTemplate() {
            const templateData = [{
                'First Name': 'John',
                'Last Name': 'Smith',
                'Email': 'john.smith@example.com',
                'preferred position': 'Forward',
                'Skill Rating': '7',
                'Veteran Status': 'veteran',
                'Buddy Pick': '',
                'Ref': 'n',
                'GM': 'n'
            },
            {
                'First Name': 'Jane',
                'Last Name': 'Doe',
                'Email': 'jane.doe@example.com',
                'preferred position': 'Defense',
                'Skill Rating': '5',
                'Veteran Status': 'rookie',
                'Buddy Pick': '',
                'Ref': 'n',
                'GM': 'y'
            },
            {
                'First Name': 'New',
                'Last Name': 'Player',
                'Email': 'new.player@example.com',
                'preferred position': 'Forward',
                'Skill Rating': 'unknown',
                'Veteran Status': 'rookie',
                'Buddy Pick': '',
                'Ref': 'n',
                'GM': 'n'
            }];

            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Player Template');
            
            // Set column widths for better readability
            worksheet['!cols'] = [
                { wch: 15 }, // First Name
                { wch: 15 }, // Last Name
                { wch: 25 }, // Email
                { wch: 15 }, // preferred position
                { wch: 12 }, // Skill Rating
                { wch: 15 }, // Veteran Status
                { wch: 15 }, // Buddy Pick
                { wch: 5 },  // Ref
                { wch: 5 }   // GM
            ];
            
            const filename = 'Hockey_Draft_Template.xlsx';
            XLSX.writeFile(workbook, filename);
        }

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Debug: Log first row to see field names
                    if (data.length > 0) {
                        console.log('First row data:', data[0]);
                        console.log('Field names:', Object.keys(data[0]));
                    }
                    
                    players = data.map((row, index) => {
                        // Normalize position to either 'Forward' or 'Defense'
                        let position = row['preferred position'] || row['Position'] || 'Forward';
                        if (position) {
                            position = position.toString().toLowerCase().trim();
                            
                            if (position.includes('forward') || position === 'f') {
                                position = 'Forward';
                            } else if (position.includes('defense') || position.includes('defence') || position === 'd') {
                                position = 'Defense';
                            } else {
                                position = 'Forward'; // Default to Forward if unclear
                            }
                        } else {
                            position = 'Forward';
                        }
                        
                        // Handle skill rating - try multiple field name variations
                        let skillRating = row['Skill Rating'] || row['skill rating'] || row['Skill'] || row['Rating'];
                        
                        // Debug log for first few players
                        if (index < 3) {
                            console.log(`Player ${index + 1} - Raw skill rating value:`, skillRating, 'Type:', typeof skillRating);
                        }
                        
                        // Handle various input types
                        if (skillRating !== undefined && skillRating !== null && skillRating !== '') {
                            // Convert to string and trim whitespace
                            const skillStr = skillRating.toString().trim();
                            
                            // Try to parse as number
                            const parsed = parseFloat(skillStr);
                            
                            // Check if it's a valid number between 1 and 10
                            if (!isNaN(parsed)) {
                                const rounded = Math.round(parsed);
                                if (rounded >= 1 && rounded <= 10) {
                                    skillRating = rounded;
                                } else {
                                    console.log(`Player ${row['First Name']} ${row['Last Name']}: Invalid rating ${parsed} (must be 1-10)`);
                                    skillRating = 0;
                                }
                            } else {
                                console.log(`Player ${row['First Name']} ${row['Last Name']}: Non-numeric rating "${skillStr}"`);
                                skillRating = 0;
                            }
                        } else {
                            console.log(`Player ${row['First Name']} ${row['Last Name']}: Empty/undefined rating`);
                            skillRating = 0;
                        }
                        
                        // Check for Ref and GM status
                        const isRef = (row['Ref'] || 'n').toString().toLowerCase() === 'y';
                        const isGM = (row['GM'] || 'n').toString().toLowerCase() === 'y';
                        
                        return {
                            id: index + 1,
                            firstName: row['First Name'] || '',
                            lastName: row['Last Name'] || '',
                            name: `${row['First Name'] || ''} ${row['Last Name'] || ''}`.trim(),
                            position: position,
                            skillRating: skillRating,
                            veteranStatus: row['Veteran Status'] || 'rookie',
                            buddyPick: row['Buddy Pick'] || '',
                            email: row['Email'] || '',
                            isRef: isRef,
                            isGM: isGM,
                            teamId: null
                        };
                    });
                    
                    renderPlayers();
                    console.log('File uploaded successfully! Loaded ' + players.length + ' players.');
                    
                    // Count players with missing ratings
                    const missingRatings = players.filter(p => p.skillRating === 0).length;
                    const validRatings = players.filter(p => p.skillRating > 0).length;
                    console.log(`Valid ratings: ${validRatings}, Missing ratings: ${missingRatings}`);
                    
                    if (missingRatings > 0) {
                        alert(`Warning: ${missingRatings} players have missing or invalid skill ratings.\n\nThese players are marked in red and must have their ratings set (1-10) before being assigned to teams.`);
                    }
                    
                    // Validate start requirements after upload
                    validateStartRequirements();
                    
                    // Auto-save after upload
                    if (draftStarted) {
                        triggerAutoSave();
                    }
                } catch (error) {
                    console.error('Error reading file:', error);
                    alert('Error reading file. Please check the console for details.');
                }
            };
            reader.readAsBinaryString(file);
        }

        // Start draft
        function startDraft() {
            const numTeams = document.getElementById('numTeamsSelect').value;
            const seasonName = document.getElementById('seasonNameInput').value;
            
            // Double-check validation (should already be validated by button state)
            if (!validateStartRequirements()) {
                console.error('Cannot start draft - missing requirements');
                return;
            }

            // Initialize teams
            teams = [];
            for (let i = 0; i < parseInt(numTeams); i++) {
                teams.push({
                    id: i + 1,
                    color: 'white',
                    players: [],
                    sortBy: 'default'
                });
            }

            generateTeamColumns();
            
            // Initialize team players display and drop zones
            teams.forEach((team, index) => {
                renderTeamPlayers(index + 1);
                updateTeamStats(index + 1);
            });
            
            updateColorDropdowns(); // Initialize color dropdown states
            draftStarted = true;
            updateButtonStates();
            
            // Hide requirements message after starting
            document.getElementById('startRequirements').style.display = 'none';
            
            console.log('Draft started with ' + numTeams + ' teams for season: ' + seasonName);
            
            // Auto-save after starting
            triggerAutoSave();
        }

        // Update color dropdowns to prevent duplicates - FIXED VERSION
        function updateColorDropdowns() {
            const selectedColors = teams.map(team => team.color);
            
            // Update each team's color dropdown
            teams.forEach(team => {
                const colorSelect = document.querySelector(`[data-team-id="${team.id}"]`);
                if (!colorSelect) return;
                
                const currentValue = colorSelect.value || team.color;
                
                // Clear and repopulate options
                colorSelect.innerHTML = '';
                
                teamColors.forEach(color => {
                    // Include the color if it's not selected by another team, or if it's this team's current selection
                    if (!selectedColors.includes(color.value) || color.value === currentValue) {
                        const option = document.createElement('option');
                        option.value = color.value;
                        option.textContent = color.label;
                        option.selected = color.value === currentValue;
                        colorSelect.appendChild(option);
                    }
                });
                
                // IMPORTANT FIX: Reapply the color class to the header after updating dropdown
                const teamColumn = colorSelect.closest('.team-column');
                const header = teamColumn.querySelector('.team-header');
                const colorClass = teamColors.find(c => c.value === currentValue).class;
                header.className = `team-header ${colorClass}`;
            });
        }

        // Generate team columns
        function generateTeamColumns() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';

            teams.forEach(team => {
                const teamColumn = document.createElement('div');
                teamColumn.className = 'team-column';
                teamColumn.innerHTML = `
                    <div class="team-header">
                        <div class="team-color-row">
                            <select class="color-select" data-team-id="${team.id}">
                                ${teamColors.map(color => 
                                    `<option value="${color.value}" ${team.color === color.value ? 'selected' : ''}>${color.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <select class="team-sort-select" data-team-id="${team.id}">
                            <option value="default" ${team.sortBy === 'default' ? 'selected' : ''}>Sort: Default</option>
                            <option value="rating-high" ${team.sortBy === 'rating-high' ? 'selected' : ''}>Rating: High to Low</option>
                            <option value="rating-low" ${team.sortBy === 'rating-low' ? 'selected' : ''}>Rating: Low to High</option>
                            <option value="position" ${team.sortBy === 'position' ? 'selected' : ''}>Position</option>
                            <option value="position-rating" ${team.sortBy === 'position-rating' ? 'selected' : ''}>Position + Rating</option>
                        </select>
                        <div class="team-stats">
                            <div class="stat-row">
                                <span>Forwards:</span>
                                <span class="forwards-count">0</span>
                            </div>
                            <div class="stat-row">
                                <span>Defense:</span>
                                <span class="defense-count">0</span>
                            </div>
                            <div class="stat-row">
                                <span>Avg Fwd Rating:</span>
                                <span class="avg-fwd-rating">0.0</span>
                            </div>
                            <div class="stat-row">
                                <span>Avg Def Rating:</span>
                                <span class="avg-def-rating">0.0</span>
                            </div>
                            <div class="stat-row">
                                <span>Total Skill:</span>
                                <span class="total-skill">0</span>
                            </div>
                            <div class="stat-row">
                                <span>Avg Rating:</span>
                                <span class="avg-rating">0.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="team-players" data-team-id="${team.id}">
                        <div class="drop-zone">Drop players here</div>
                    </div>
                `;

                // Add color change event listener
                const colorSelect = teamColumn.querySelector('.color-select');
                colorSelect.addEventListener('change', (e) => {
                    const teamId = parseInt(e.target.dataset.teamId);
                    const color = e.target.value;
                    const colorClass = teamColors.find(c => c.value === color).class;
                    
                    // Update team data
                    teams[teamId - 1].color = color;
                    
                    // Update header styling
                    const header = teamColumn.querySelector('.team-header');
                    header.className = `team-header ${colorClass}`;
                    
                    // Update all color dropdowns to prevent duplicates
                    updateColorDropdowns();
                    
                    // Auto-save
                    triggerAutoSave();
                });
                
                // Add sort change event listener
                const sortSelect = teamColumn.querySelector('.team-sort-select');
                sortSelect.addEventListener('change', (e) => {
                    const teamId = parseInt(e.target.dataset.teamId);
                    teams[teamId - 1].sortBy = e.target.value;
                    renderTeamPlayers(teamId);
                    
                    // Auto-save
                    triggerAutoSave();
                });

                // Set initial color and apply styling
                const initialColor = teamColors.find(c => c.value === team.color);
                const header = teamColumn.querySelector('.team-header');
                header.className = `team-header ${initialColor.class}`;
                
                // Set the dropdown to the correct initial value
                colorSelect.value = team.color;

                // Add drop zone event listeners to team players area
                const teamPlayersDiv = teamColumn.querySelector('.team-players');
                teamPlayersDiv.addEventListener('dragover', handleDragOver);
                teamPlayersDiv.addEventListener('dragleave', handleDragLeave);
                teamPlayersDiv.addEventListener('drop', handleDrop);

                container.appendChild(teamColumn);
            });
        }

        // Filter players based on current filter
        function filterPlayers(playersList) {
            switch (currentFilter) {
                case 'forward':
                    return playersList.filter(p => p.position === 'Forward');
                case 'defense':
                    return playersList.filter(p => p.position === 'Defense');
                case 'ref':
                    return playersList.filter(p => p.isRef);
                case 'gm':
                    return playersList.filter(p => p.isGM);
                case 'buddy':
                    return playersList.filter(p => p.buddyPick);
                default:
                    return playersList;
            }
        }

        // Render players in the pool
        function renderPlayers() {
            const container = document.getElementById('playersContainer');
            let poolPlayers = players.filter(player => player.teamId === null);
            
            // Apply filter
            poolPlayers = filterPlayers(poolPlayers);
            
            // Sort players
            const sortedPlayers = [...poolPlayers].sort((a, b) => {
                let comparison = 0;
                
                switch (currentSort.by) {
                    case 'name':
                        comparison = a.lastName.toLowerCase().localeCompare(b.lastName.toLowerCase());
                        break;
                    case 'position':
                        // First sort by position (Defense then Forward)
                        comparison = a.position.localeCompare(b.position);
                        // If positions are the same, sort by skill rating (highest first)
                        if (comparison === 0) {
                            comparison = b.skillRating - a.skillRating;
                        }
                        break;
                    case 'skill':
                        comparison = a.skillRating - b.skillRating;
                        break;
                    case 'veteran':
                        comparison = a.veteranStatus.localeCompare(b.veteranStatus);
                        break;
                }
                
                return currentSort.order === 'asc' ? comparison : -comparison;
            });

            container.innerHTML = '';
            sortedPlayers.forEach(player => {
                const playerCard = createPlayerCard(player);
                container.appendChild(playerCard);
            });
        }

        // Create player card element
        function createPlayerCard(player) {
            const playerCard = document.createElement('div');
            playerCard.className = `player-card ${compactView ? 'compact' : ''}`;
            playerCard.draggable = true;
            playerCard.dataset.playerId = player.id;
            
            let tags = '';
            if (player.isRef) tags += '<span class="player-tag tag-ref">REF</span>';
            if (player.isGM) tags += '<span class="player-tag tag-gm">GM</span>';
            
            if (compactView) {
                let skillDisplay = '';
                // Always allow editing skill rating (not just when draft started)
                skillDisplay = `<select class="player-edit-select skill-select" data-player-id="${player.id}">`;
                for (let i = 0; i <= 10; i++) {
                    skillDisplay += `<option value="${i}" ${player.skillRating === i ? 'selected' : ''}>${i === 0 ? '0 (Missing)' : i}</option>`;
                }
                skillDisplay += '</select>';
                
                playerCard.innerHTML = `
                    <div class="player-name">${player.name}${tags}</div>
                    <div class="player-details">
                        <div class="player-detail show-compact">${player.position}</div>
                        <div class="player-detail show-compact">${skillDisplay}</div>
                    </div>
                `;
            } else {
                let positionDisplay = '';
                let skillDisplay = '';
                
                // Always allow editing (not just when draft started)
                // Create editable position dropdown
                positionDisplay = `Position: <select class="player-edit-select position-select" data-player-id="${player.id}">
                    <option value="Forward" ${player.position === 'Forward' ? 'selected' : ''}>Forward</option>
                    <option value="Defense" ${player.position === 'Defense' ? 'selected' : ''}>Defense</option>
                </select>`;
                
                // Create editable skill rating dropdown
                skillDisplay = `Skill: <select class="player-edit-select skill-select" data-player-id="${player.id}">`;
                for (let i = 0; i <= 10; i++) {
                    skillDisplay += `<option value="${i}" ${player.skillRating === i ? 'selected' : ''}>${i === 0 ? '0 (Missing)' : i}</option>`;
                }
                skillDisplay += '</select>';
                
                playerCard.innerHTML = `
                    <div class="player-name">${player.name}${tags}</div>
                    <div class="player-details">
                        <div class="player-detail">${positionDisplay}</div>
                        <div class="player-detail ${player.skillRating === 0 ? 'missing-rating' : ''}">${skillDisplay}</div>
                        <div class="player-detail">Status: ${player.veteranStatus}</div>
                        ${player.buddyPick ? `<div class="player-detail">Buddy: ${player.buddyPick}</div>` : ''}
                    </div>
                `;
            }

            // Add event listeners for editable fields
            // Prevent drag when clicking on selects
            const selects = playerCard.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    playerCard.draggable = false;
                });
                
                select.addEventListener('mouseup', () => {
                    playerCard.draggable = true;
                });
                
                // Prevent drag on click
                select.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });
            
            // Position change handler
            const positionSelect = playerCard.querySelector('.position-select');
            if (positionSelect) {
                positionSelect.addEventListener('change', (e) => {
                    const playerId = parseInt(e.target.dataset.playerId);
                    const newPosition = e.target.value;
                    updatePlayerPosition(playerId, newPosition);
                });
            }
            
            // Skill rating change handler
            const skillSelect = playerCard.querySelector('.skill-select');
            if (skillSelect) {
                skillSelect.addEventListener('change', (e) => {
                    const playerId = parseInt(e.target.dataset.playerId);
                    const newRating = parseInt(e.target.value);
                    updatePlayerSkillRating(playerId, newRating);
                });
            }

            playerCard.addEventListener('dragstart', handleDragStart);
            playerCard.addEventListener('dragend', handleDragEnd);
            
            return playerCard;
        }

        // Update player position
        function updatePlayerPosition(playerId, newPosition) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            player.position = newPosition;
            
            // If player is on a team, update team stats
            if (player.teamId !== null) {
                updateTeamStats(player.teamId);
            }
            
            // Auto-save
            triggerAutoSave();
            
            console.log(`Updated ${player.name} position to ${newPosition}`);
        }

        // Update player skill rating
        function updatePlayerSkillRating(playerId, newRating) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            const oldRating = player.skillRating;
            player.skillRating = newRating;
            
            // If rating changed from/to 0, need full re-render for style update
            if (oldRating === 0 || newRating === 0) {
                // Re-render the player card to update highlighting
                if (player.teamId === null) {
                    renderPlayers();
                } else {
                    renderTeamPlayers(player.teamId);
                }
            }
            
            // Update team stats if player is on a team
            if (player.teamId !== null) {
                updateTeamStats(player.teamId);
            }
            
            // Auto-save
            triggerAutoSave();
            
            console.log(`Updated ${player.name} skill rating from ${oldRating} to ${newRating}`);
        }

        // Sort team players
        function sortTeamPlayers(teamPlayers, sortBy) {
            return [...teamPlayers].sort((a, b) => {
                switch (sortBy) {
                    case 'rating-high':
                        return b.skillRating - a.skillRating;
                    case 'rating-low':
                        return a.skillRating - b.skillRating;
                    case 'position':
                        return a.position.localeCompare(b.position);
                    case 'position-rating':
                        const posComp = a.position.localeCompare(b.position);
                        return posComp !== 0 ? posComp : b.skillRating - a.skillRating;
                    default:
                        return 0; // Keep original order
                }
            });
        }

        // Drag and drop handlers
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.playerId);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            // Only remove drag-over if we're actually leaving the element, not just moving to a child
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const playerId = parseInt(e.dataTransfer.getData('text/plain'));
            const teamId = parseInt(e.currentTarget.dataset.teamId);
            
            // Check if player has 0 skill rating
            const player = players.find(p => p.id === playerId);
            if (player && player.skillRating === 0 && teamId !== null) {
                // Show warning and don't allow the move
                const modal = document.getElementById('zeroRatingModal');
                document.getElementById('zeroRatingMessage').innerHTML = 
                    `<strong>${player.name}</strong> has no skill rating assigned.<br><br>
                    Please set a skill rating between 1-10 before assigning to a team.`;
                modal.classList.add('show');
                return;
            }
            
            movePlayerToTeam(playerId, teamId);
        }

        // Move player to team - FIXED VERSION
        function movePlayerToTeam(playerId, teamId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            let previousTeamId = player.teamId;

            // Remove from current team if any
            if (player.teamId !== null) {
                const currentTeam = teams[player.teamId - 1];
                currentTeam.players = currentTeam.players.filter(p => p.id !== playerId);
                updateTeamStats(player.teamId);
            }

            // Add to new team
            player.teamId = teamId;
            if (teamId !== null) {
                teams[teamId - 1].players.push(player);
                updateTeamStats(teamId);
            }

            // Re-render player pool
            renderPlayers();
            
            // Re-render affected team columns
            if (previousTeamId !== null) {
                renderTeamPlayers(previousTeamId);
            }
            if (teamId !== null) {
                renderTeamPlayers(teamId);
            }
            
            // Auto-save after move
            triggerAutoSave();
        }

        // Render team players - FIXED VERSION
        function renderTeamPlayers(teamId) {
            const teamPlayersDiv = document.querySelector(`.team-players[data-team-id="${teamId}"]`);
            if (!teamPlayersDiv) return;

            const team = teams[teamId - 1];
            teamPlayersDiv.innerHTML = '';
            
            // Sort team players based on team's sort setting
            const sortedPlayers = sortTeamPlayers(team.players, team.sortBy);

            sortedPlayers.forEach(player => {
                const playerCard = createPlayerCard(player);
                playerCard.addEventListener('dblclick', () => {
                    // Double-click always returns to pool (no skill rating check needed)
                    movePlayerToTeam(player.id, null);
                });
                teamPlayersDiv.appendChild(playerCard);
            });

            if (team.players.length === 0) {
                const dropZone = document.createElement('div');
                dropZone.className = 'drop-zone';
                dropZone.textContent = 'Drop players here';
                teamPlayersDiv.appendChild(dropZone);
            }
            
            // FIX: Re-attach drag and drop event listeners after re-rendering
            teamPlayersDiv.addEventListener('dragover', handleDragOver);
            teamPlayersDiv.addEventListener('dragleave', handleDragLeave);
            teamPlayersDiv.addEventListener('drop', handleDrop);
        }

        // Update team stats
        function updateTeamStats(teamId) {
            const team = teams[teamId - 1];
            const forwards = team.players.filter(p => p.position === 'Forward');
            const defense = team.players.filter(p => p.position === 'Defense');
            
            const forwardCount = forwards.length;
            const defenseCount = defense.length;
            
            const totalSkill = team.players.reduce((sum, p) => sum + p.skillRating, 0);
            const avgRating = team.players.length > 0 
                ? (totalSkill / team.players.length).toFixed(1)
                : '0.0';
            
            // Calculate average forward rating (excluding 0 ratings from average)
            const validForwards = forwards.filter(p => p.skillRating > 0);
            const avgFwdRating = validForwards.length > 0
                ? (validForwards.reduce((sum, p) => sum + p.skillRating, 0) / validForwards.length).toFixed(1)
                : '0.0';
            
            // Calculate average defense rating (excluding 0 ratings from average)
            const validDefense = defense.filter(p => p.skillRating > 0);
            const avgDefRating = validDefense.length > 0
                ? (validDefense.reduce((sum, p) => sum + p.skillRating, 0) / validDefense.length).toFixed(1)
                : '0.0';

            const teamColumn = document.querySelector(`.team-players[data-team-id="${teamId}"]`).closest('.team-column');
            teamColumn.querySelector('.forwards-count').textContent = forwardCount;
            teamColumn.querySelector('.defense-count').textContent = defenseCount;
            teamColumn.querySelector('.total-skill').textContent = totalSkill;
            teamColumn.querySelector('.avg-rating').textContent = avgRating;
            teamColumn.querySelector('.avg-fwd-rating').textContent = avgFwdRating;
            teamColumn.querySelector('.avg-def-rating').textContent = avgDefRating;
        }

        // Sort functions
        function toggleSort() {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            document.getElementById('sortBtn').textContent = currentSort.order === 'asc' ? '↑' : '↓';
            renderPlayers();
            triggerAutoSave();
        }

        function updateSort() {
            currentSort.by = document.getElementById('sortBySelect').value;
            renderPlayers();
            triggerAutoSave();
        }

        // Save draft
        function saveDraft() {
            const seasonName = document.getElementById('seasonNameInput').value;
            const data = [];

            teams.forEach(team => {
                const colorLabel = teamColors.find(c => c.value === team.color).label;
                team.players.forEach(player => {
                    data.push({
                        'Team': colorLabel,
                        'First Name': player.firstName,
                        'Last Name': player.lastName,
                        'Email': player.email,
                        'preferred position': player.position,
                        'Skill Rating': player.skillRating,
                        'Veteran Status': player.veteranStatus,
                        'Buddy Pick': player.buddyPick,
                        'Ref': player.isRef ? 'y' : 'n',
                        'GM': player.isGM ? 'y' : 'n'
                    });
                });
            });

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Draft Results');
            
            const filename = `${seasonName}_Draft_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, filename);
        }

        // Reset draft
        function resetDraft() {
            // Note: In sandboxed environment, confirm/alert dialogs don't work
            // For production, you might want to implement a custom confirmation modal
            
            console.log('Resetting draft...');
            console.log('Before reset - players with teams:', players.filter(p => p.teamId !== null).length);
            console.log('Teams before reset:', teams.map(t => ({id: t.id, players: t.players.length})));
            
            // Reset all players to pool
            for (let i = 0; i < players.length; i++) {
                players[i].teamId = null;
            }
            
            // Store the number of teams
            const numTeams = teams.length;
            
            // Reset teams array completely
            teams = [];
            for (let i = 0; i < numTeams; i++) {
                teams.push({
                    id: i + 1,
                    color: 'white',
                    players: [],
                    sortBy: 'default'
                });
            }
            
            console.log('After reset - players with teams:', players.filter(p => p.teamId !== null).length);
            console.log('Teams after reset:', teams.map(t => ({id: t.id, players: t.players.length})));
            
            // Force complete UI refresh
            generateTeamColumns();
            
            // Initialize team displays
            teams.forEach((team, index) => {
                renderTeamPlayers(index + 1);
                updateTeamStats(index + 1);
            });
            
            // Re-render player pool (all players including GMs will be back in pool)
            renderPlayers();
            
            // Update color dropdowns
            updateColorDropdowns();
            
            console.log('Draft reset complete - UI should be updated');
            
            // Auto-save after reset
            triggerAutoSave();
        }

        // Assign GMs to teams automatically
        function assignGMsToTeams() {
            // Find all GMs in the player pool (not already on teams)
            const availableGMs = players.filter(p => p.isGM && p.teamId === null);
            const numTeams = teams.length;
            
            console.log(`Found ${availableGMs.length} GMs for ${numTeams} teams`);
            
            if (availableGMs.length === 0) {
                alert('No GMs found in the player pool.');
                return;
            }
            
            if (availableGMs.length < numTeams) {
                alert(`Not enough GMs! Found ${availableGMs.length} GMs but have ${numTeams} teams.\n\nPlease mark more players as GMs or reduce the number of teams.`);
                return;
            }
            
            if (availableGMs.length > numTeams) {
                alert(`Too many GMs! Found ${availableGMs.length} GMs but only have ${numTeams} teams.\n\nOnly the first ${numTeams} GMs will be assigned.`);
            }
            
            // Check if any teams already have GMs
            const teamsWithGMs = teams.filter(team => 
                team.players.some(player => player.isGM)
            );
            
            if (teamsWithGMs.length > 0) {
                const confirmMessage = `${teamsWithGMs.length} team(s) already have GMs. Do you want to continue assigning GMs to teams without GMs?`;
                console.log(confirmMessage);
                // In sandbox, just proceed
            }
            
            // Assign one GM to each team that doesn't have one
            let gmIndex = 0;
            teams.forEach((team, teamIndex) => {
                // Check if team already has a GM
                const hasGM = team.players.some(player => player.isGM);
                
                if (!hasGM && gmIndex < availableGMs.length) {
                    const gm = availableGMs[gmIndex];
                    
                    // Check if GM has valid skill rating
                    if (gm.skillRating === 0) {
                        console.warn(`Warning: GM ${gm.name} has no skill rating. Assigning anyway.`);
                    }
                    
                    // Move GM to team
                    gm.teamId = team.id;
                    team.players.push(gm);
                    
                    console.log(`Assigned GM ${gm.name} to Team ${team.id}`);
                    gmIndex++;
                }
            });
            
            // Re-render everything
            renderPlayers();
            teams.forEach((team, index) => {
                renderTeamPlayers(index + 1);
                updateTeamStats(index + 1);
            });
            
            // Auto-save
            triggerAutoSave();
            
            const assignedCount = Math.min(availableGMs.length, numTeams - teamsWithGMs.length);
            if (assignedCount > 0) {
                console.log(`Successfully assigned ${assignedCount} GMs to teams.`);
            }
        }

        // Update button states
        function updateButtonStates() {
            const saveBtn = document.getElementById('saveDraftBtn');
            const resetBtn = document.getElementById('resetDraftBtn');
            const assignGMsBtn = document.getElementById('assignGMsBtn');
            
            saveBtn.disabled = !draftStarted;
            resetBtn.disabled = !draftStarted;
            assignGMsBtn.disabled = !draftStarted;
            
            console.log('Draft started:', draftStarted, 'Reset button disabled:', resetBtn.disabled);
        }

        // Add player pool drop zone
        const playersContainer = document.getElementById('playersContainer');
        playersContainer.addEventListener('dragover', handleDragOver);
        playersContainer.addEventListener('dragleave', handleDragLeave);
        playersContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const playerId = parseInt(e.dataTransfer.getData('text/plain'));
            // Allow any player to be returned to the pool (teamId = null)
            movePlayerToTeam(playerId, null);
        });
    </script>
</body>
</html>